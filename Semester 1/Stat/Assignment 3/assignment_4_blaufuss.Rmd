---
title: "assignment_4_blaufuss"
author: "Dennis Blaufuss"
date: "12/01/2021"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rethinking)
library(tidyverse)
```

##### 1. The following plot of the posterior predictions of the Chimpanzee experiment is the bottom panel of Figure 11.4 on page 333.

![](/Users/dennisblaufuss/Desktop/SS_assignment_4.png)

##### Adapt the code in the book for plotting the observed data (Figure 11.4, top panel) to recreate this posterior predictions plot. Your answer must include the plot and your code.

```{r}
data(chimpanzees)
d <- chimpanzees
d$treatment <- 1 + d$prosoc_left + 2*d$condition

pl <- by( d$pulled_left , list( d$actor , d$treatment ) , mean )

plot( NULL , xlim=c(1,28) , ylim=c(0,1) , xlab="" ,
    ylab="proportion left lever" , xaxt="n" , yaxt="n" )
axis( 2 , at=c(0,0.5,1) , labels=c(0,0.5,1) )
abline( h=0.5 , lty=2 )
for ( j in 1:7 ) abline( v=(j-1)*4+4.5 , lwd=0.5 )
for ( j in 1:7 ) text( (j-1)*4+2.5 , 1.1 , concat("actor ",j) , xpd=TRUE )
for ( j in (1:7)[-2] ) {
    lines( (j-1)*4+c(1,3) , pl[j,c(1,3)] , lwd=2 , col=rangi2 )
    lines( (j-1)*4+c(2,4) , pl[j,c(2,4)] , lwd=2 , col=rangi2 )
}
points( 1:28 , t(pl) , pch=16 , col="white" , cex=1.7 )
points( 1:28 , t(pl) , pch=c(1,1,16,16) , col=rangi2 , lwd=2 )
yoff <- 0.01
text( 1 , pl[1,1]-yoff , "R/N" , pos=1 , cex=0.8 )
text( 2 , pl[1,2]+yoff , "L/N" , pos=3 , cex=0.8 )
text( 3 , pl[1,3]-yoff , "R/P" , pos=1 , cex=0.8 )
text( 4 , pl[1,4]+yoff , "L/P" , pos=3 , cex=0.8 )
mtext( "posterior predictions\n" )
```

***

##### 2. The Wines2012 data set includes expert scores given by expert American and French judges.

```{r}
data(Wines2012)
d <- Wines2012
precis(d)
```

##### You should standardize and create IDs to distinguish between American and French judges and American and French wines:

```{r}
# standardize scores and create IDs for
# American/French judges and wines
dat_list <- list(
 S = standardize(d$score),
 jid = as.integer(d$judge),
 wid = as.integer(d$wine)
 )
```

##### Your goal is to model the score, the subjective rating assigned by each judge to each wine.
##### For this first model, you should only consider variation among judges and wines.

##### (a) Construct index variables for judge and wine and using these index variables to construct a linear regression model. You should end up with 9 judge parameters and 20 wine parameters.
##### (b) Justify the priors you use.
##### (c) Use ulam instead of quap to build this model.
##### (d) Check your chains for convergence.
##### Is there variation among individual judges and individual wines? Are there patterns you can notice just by plotting the differences? Which judges have the lowest and highest ratings? Which wines are rated worst and which best on average?

```{r, message=FALSE}
m2 <- ulam(
  alist(
    S ~ dnorm(mu, sigma),
    mu <- a[jid] + b[wid], 
    a[jid] ~ dnorm(0, 0.5), 
    b[wid] ~ dnorm(0, 0.5), 
    sigma ~dexp(1)
  ), 
  data=dat_list, 
  chains=4, 
  cores=4)

precis(m2, 2)
```

Note: I have disabled messages on this code block since with knitting it outputs an error but still the model works etc. As discussed in class briefly I guess this is due to M1. But since the model works and takes normal time to be computed I'm sure there is no issue (when running the code normally in RStudio everything works fine).

```{r}
traceplot(m2)
```

```{r}
plot(precis(m2, 2))
```

###### Answer:
The model is pretty simple using ulam instead of quap method. The only issue would be with the priors but since weâ€™ve standardized the outcome, we can use the ordinary N(0,0.5) prior from examples with standardized outcomes. Then the prior outcomes will stay largely within the possible outcome space. Still, there is room for regularization regarding this.

By taking a look at the output of precis function we first can note that all Rhats are 1. Furthermore our n_effs are mostly above our sample size of 2000. So that is looking good at first glance (keep in mind that those can be misleading though). Taking a look at our trace plots actually strengthen the assumption that everything is fine: They look as they should like hairy caterpillars. That means that the chains move quickly through it and mix in the same region.

Now, plotting the output of precis function we can take a look at each judge/wine: a parameters are judges and b's are wines. Having a look at the judges first: Each represents an average deviation of the scores. Judge 8 seems to be the harshest one with the lowest score whilst judge 5 seems to like all wines a lot :D. Furthermore we can state that most of the judges are pretty different in their taste-harshness.

On the other hand, while having a look at the wines we can't tell that much of a difference here. Wine 4 is rated the best (on average) while wine 18 apparently is pretty bad (rated worst on average by a bit). We can state that the judges are way better the differentiate between than the wines that mostly are midfield across the board.

***

##### 3. Now consider three features of the wines and judges:
* ##### flight: whether the wine is red or white.
* ##### wine.amer: Indicator variable for American wines
* ##### judge.amer: Indicator variable for American judges

##### Use indicator variables to model the influence of these features on the scores.
##### Here is a line of R code to convert the flight values (strings) to integer values of an indicator:

```{r}
# indicator for red wine
R = ifelse(d$flight =="red", 1L, 0L)
```

__Tip:__ _Note that 1L and 0L are integers, whereas 1 and 0 are real (actually, floating point) numbers. Indicator and index values should be integers._

##### Specifically,
##### (a) Omit the individual judge and wine index variables from Problem 2.
##### (b) Do not include interaction effects.
##### (c) Use ulam, justify your priors, and check your chains.
##### What do you conclude about the differences among the wines and judges? Compare your results to the results from Problem 2.

```{r, message=FALSE}
dat_list2 <- list(
    S = standardize(d$score),
    W = d$wine.amer,
    J = d$judge.amer,
    R = ifelse(d$flight == "red", 1L, 0L))

m3 <- ulam(
  alist(
    S ~ dnorm(mu, sigma),
    mu <- a + bW*W + bJ*J + bR*R, 
    a ~ dnorm(0, 0.2), 
    bW~ dnorm(0, 0.5),
    bJ~ dnorm(0, 0.5),
    bR~ dnorm(0, 0.5),
    sigma ~ dexp(1)
    ), 
  data=dat_list2, 
  chains=4 , 
  cores=4)

precis(m3)
```

Same note as for previous model applies.

```{r}
traceplot(m3)
```

```{r}
plot(precis(m3, 2))
```

###### Answer:

While checking the trace plot and precis output we can observe the same as in Problem 2: everything looks fine regarding chains! Again for the priors we can use the same ordinary N(0,0.5) as we standardized outcome. Now taking a look at the different variables we can note the following three points:

* The flight of the wine (meaning it being red or white) does not seem to have any impact on the rating on average (bR is around zero).

* The not American judges (thus french ones i think) seem to be the harsher ones (bJ above zero).

* The American wines seem to perform worse than the not American wines on average (bW below zero).

Those observations somewhat reflect the ones from problem 2: We have more deviation within the group of judges than within the group of wines: The origin of the judge seems to have an impact on the rating (thus one out of one variable), while for the wines only one of the two variable seem to have an impact: The origin does while the fleet doesn't.
